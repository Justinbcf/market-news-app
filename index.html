<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Super Fancy Market News Tool</title>
  <meta name="description" content="Finnhub company-news scanner with sentiment/topic chips, article summarization, and Reddit trending tickers via Worker." />
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#0b1020" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Market News" />
  <meta name="mobile-web-app-capable" content="yes" />
  
  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%230b1020' width='180' height='180'/><text x='90' y='110' font-family='Arial' font-size='100' fill='%2322d3ee' text-anchor='middle'>ðŸ“ˆ</text></svg>" />
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%230b1020' width='180' height='180'/><text x='90' y='110' font-family='Arial' font-size='100' fill='%2322d3ee' text-anchor='middle'>ðŸ“ˆ</text></svg>" />
  
  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(registration => {
            console.log('SW registered: ', registration);
          })
          .catch(registrationError => {
            console.log('SW registration failed: ', registrationError);
          });
      });
    }
  </script>
  <style>
    :root{ --bg:#0b1020; --panel:#0f172a; --panel-2:#10192f; --text:#e5e7eb; --muted:#94a3b8; --border:#1f2a44; --accent:#22d3ee; --accent-2:#1fb6ff; --ok:#10b981; --warn:#f59e0b; --err:#ef4444; --pill:#233045; --shadow:0 6px 18px rgba(0,0,0,.35) }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    a{color:var(--accent)}
    .wrap{max-width:1000px;margin:36px auto;padding:0 18px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    h1{font-size:26px;margin:0}
    .sub{color:var(--muted)}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:var(--shadow);margin-bottom:14px}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    label{font-weight:600}
    input[type=text],input[type=password],select{background:#0b1220;color:var(--text);border:1px solid var(--pill);border-radius:10px;padding:10px 12px;outline:none}
    input[type=text]{flex:1 1 340px}
    .key{min-width:320px}
    button{background:linear-gradient(135deg,var(--accent-2),var(--accent));border:none;color:#071018;font-weight:700;padding:10px 14px;border-radius:10px;cursor:pointer}
    button.ghost{background:transparent;color:#93c5fd;border:1px solid #1f2a44}
    button:disabled{opacity:.6;cursor:not-allowed}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;color:var(--muted);margin-top:10px}
    .pill{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--pill);color:var(--muted)}
    .pill.ok{color:var(--ok)} .pill.err{color:#fecaca;border-color:#7f1d1d}
    .status{margin-top:10px;min-height:1.2em}
    .banner{display:none;margin:12px 0;padding:10px;border-radius:10px;border:1px solid #553;background:#2a1b0b;color:#ffd7a3}
    .results{margin-top:16px;display:grid;gap:12px}
    .item{background:#0b1220;border:1px solid var(--pill);border-radius:10px;padding:12px}
    .item a{color:var(--accent);text-decoration:none}
    .score-pos{color:var(--ok)} .score-neg{color:var(--err)}
    .kbd{border:1px solid var(--border);border-bottom-width:3px;padding:1px 6px;border-radius:6px;font-family:ui-monospace,Consolas,monospace;font-size:12px;color:#cbd5e1}
    .right{margin-left:auto}
    .small{font-size:12px}
    .spinner{width:14px;height:14px;border:2px solid #7dd3fc;border-top-color:transparent;border-radius:50%;display:inline-block;animation:spin .9s linear infinite}
    details.logs{margin-top:10px}
    .oktxt{color:var(--ok)} .errtxt{color:#fecaca} .warntxt{color:#fde68a}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* AI Features */
    .ai-enhanced{background:linear-gradient(135deg,rgba(34,211,238,.08),rgba(168,85,247,.08));border:1px solid rgba(34,211,238,.2)}
    .ai-badge{background:rgba(34,211,238,.12);color:#22d3ee;border:1px solid rgba(34,211,238,.3)}
    .ai-insights{border-top:1px solid var(--border);margin-top:12px;padding-top:12px}
    .ai-insights .summary-title{color:#22d3ee}
    .market-implication{color:#22d3ee;font-style:italic}
    .ai-sentiment-bullish{background:rgba(34,197,94,.12);color:#22c55e}
    .ai-sentiment-bearish{background:rgba(239,68,68,.12);color:#ef4444}
    .ai-sentiment-neutral{background:rgba(156,163,175,.12);color:#9ca3af}

    /* Chips */
    .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    .chip{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid var(--pill);line-height:1.2}
    .chip.bull{background:rgba(16,185,129,.12);color:#34d399;border-color:#065f46}
    .chip.bear{background:rgba(239,68,68,.12);color:#f87171;border-color:#7f1d1d}
    .chip.neutral{background:#0b1220;color:#9ca3af}
    .chip.tag{background:#0b1220;color:#93c5fd;border-color:#1e3a8a}
    .chip.warn{background:rgba(245,158,11,.12);color:#fbbf24;border-color:#92400e}

    /* Summary box */
    .summary-box { margin-top:8px; color:#cbd5e1; }
    .summary-title { margin-top:6px; font-weight:600; color:#22d3ee }
    .summary-text { margin:6px 0 4px; line-height:1.45 }
    .summary-list { margin:6px 0 0 18px }

    /* Reddit trending table */
    .trend-grid{display:grid;grid-template-columns:80px 100px 1fr 120px 80px 110px;gap:6px;align-items:center}
    .trend-header{font-weight:700;color:#a5b4fc}
    .trend-row{padding:8px;border:1px solid var(--pill);border-radius:10px;background:#0b1220;display:grid;grid-template-columns:80px 100px 1fr 120px 80px 110px;gap:6px;align-items:center}
    .trend-actions button{padding:6px 10px}

    /* Login overlay */
    .login-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(11,16,32,.95);backdrop-filter:blur(8px);z-index:1000;display:flex;align-items:center;justify-content:center}
    .login-modal{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:32px;max-width:400px;width:90%;box-shadow:var(--shadow)}
    .login-title{font-size:24px;font-weight:700;margin-bottom:8px;color:var(--text)}
    .login-sub{color:var(--muted);margin-bottom:24px}
    .login-field{margin-bottom:16px}
    .login-field label{display:block;margin-bottom:6px;font-weight:600}
    .login-field input{width:100%;box-sizing:border-box}
    .login-actions{display:flex;gap:12px;margin-top:24px}
    .login-actions button{flex:1}
    .user-info{display:flex;align-items:center;gap:12px;color:var(--muted)}
    .user-info .user-email{font-weight:600;color:var(--text)}
    .usage-info{font-size:12px;color:var(--muted)}
    /* Mobile Responsive */
    @media (max-width: 768px) {
      .wrap{margin:20px auto;padding:0 12px}
      h1{font-size:20px}
      .card{padding:12px;margin-bottom:12px}
      .row{flex-direction:column;align-items:stretch}
      input[type=text]{flex:1}
      .key{min-width:100%;width:100%}
      .toolbar{flex-direction:column;align-items:stretch;gap:8px}
      .toolbar label{margin-bottom:4px}
      .trend-grid,.trend-row{grid-template-columns:50px 70px 1fr 70px 50px;font-size:11px}
      .trend-actions button{padding:4px 8px;font-size:11px}
      .login-modal{margin:20px;padding:24px}
      .login-title{font-size:20px}
      .user-info{flex-direction:column;align-items:flex-start;gap:8px}
      .usage-info{margin-bottom:8px}
    }
    
    @media (max-width: 480px) {
      .wrap{margin:12px auto;padding:0 8px}
      h1{font-size:18px}
      .card{padding:8px;border-radius:8px}
      .trend-grid,.trend-row{grid-template-columns:40px 60px 1fr 60px 40px;font-size:10px}
      .login-modal{margin:12px;padding:16px}
      .login-actions{flex-direction:column}
      .login-actions button{margin-bottom:8px}
    }

    /* PWA Safe Areas for iPhone X+ */
    @supports (padding: max(0px)) {
      .wrap{padding-left:max(12px, env(safe-area-inset-left));padding-right:max(12px, env(safe-area-inset-right))}
      body{padding-bottom:env(safe-area-inset-bottom)}
    }

    /* iOS Safari fixes */
    @supports (-webkit-touch-callout: none) {
      .login-overlay{-webkit-overflow-scrolling:touch}
      input{font-size:16px} /* Prevent zoom on focus */
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Super Fancy Market News Tool</h1>
        <div class="sub">Finnhub free api if you dont have one - d473qopr01qh8nnb0j30d473qopr01qh8nnb0j3g</div>
      </div>
      <div class="user-info hidden" id="userInfo">
        <span>Welcome <span class="user-email" id="userEmail"></span></span>
        <div class="usage-info" id="usageInfo"></div>
        <button id="btnLogout" class="ghost">Logout</button>
      </div>
    </header>

    <div id="banner" class="banner"></div>

    <!-- SETTINGS -->
    <section class="card">
      <div class="row">
        <label for="keyFinnhub">Finnhub API key</label>
        <input id="keyFinnhub" class="key" type="password" placeholder="Finnhub token (e.g., c123â€¦)" />
        <button id="btnSave">Save</button>
        <span class="pill" id="pillKey">Not saved</span>
        <button id="btnTest" title="Test this key">Test</button>
      </div>
      <div class="toolbar small">
        <strong>Privacy:</strong> The key is stored only in <em>this browser</em> and sent directly to Finnhub.
      </div>
    </section>

    <!-- AI SETTINGS -->
    <section class="card">
      <div class="row">
        <label for="keyAI">ðŸ¤– OpenAI API Key</label>
        <input id="keyAI" class="key" type="password" placeholder="sk-... (for GPT-3.5-Turbo analysis)" />
        <button id="btnSaveAI">Save</button>
        <span class="pill" id="pillAIKey">Not saved</span>
        <button id="btnTestAI" title="Test AI features">Test</button>
      </div>
      <div class="toolbar small">
        <strong>AI Features:</strong> Enhanced sentiment analysis, smart categorization, market insights, and AI-powered summaries using GPT-3.5-Turbo.
      </div>
      <div class="toolbar small" style="margin-top:8px">
        <strong>Get API Key:</strong> <a href="https://platform.openai.com/api-keys" target="_blank" style="color: var(--accent)">platform.openai.com</a>
      </div>
      <div class="toolbar small" style="margin-top:8px">
        <strong>Troubleshooting:</strong> If you get 404 errors, ensure your API key has sufficient credits and GPT-3.5-Turbo access. For 429 errors, wait 60 seconds then retry.
      </div>
    </section>

    <!-- SEARCH -->
    <section class="card" aria-label="Search">
      <div class="row">
        <label for="ticker">Ticker</label>
        <input id="ticker" type="text" placeholder="Try: NVDA, MSFT, AAPL" />
        <button id="btnStart"><span class="spinner" id="spin" style="display:none"></span> Search</button>
        <button id="btnCancel" class="ghost" disabled>Cancel</button>
        <span class="right small sub" id="count"></span>
      </div>
      <div class="toolbar">
        <label for="sort">Sort</label>
        <select id="sort">
          <option value="relevance">Relevance</option>
          <option value="time">Newest</option>
          <option value="impact">Impact score</option>
        </select>
        <label for="dedupe">De-dupe</label>
        <select id="dedupe">
          <option value="url">By URL</option>
          <option value="title">By Title+Source</option>
          <option value="off">Off</option>
        </select>
        <label for="maxResults">Max results</label>
        <select id="maxResults">
          <option>20</option>
          <option>50</option>
          <option selected>100</option>
          <option>200</option>
        </select>
        <label for="daysBack">Days back</label>
        <select id="daysBack">
          <option value="1">1</option>
          <option value="7" selected>7</option>
          <option value="14">14</option>
          <option value="30">30</option>
          <option value="90">90</option>
        </select>
      </div>
      <div id="status" class="status sub" aria-live="polite"></div>
      <details class="logs"><summary>Status details</summary><div id="log" class="small"></div></details>
      <div id="results" class="results" role="list"></div>
      <div class="toolbar small">Tip: Press <span class="kbd">Enter</span> to search. Company news requires a <strong>ticker</strong>.</div>
    </section>

    <!-- REDDIT TRENDING -->
    <section class="card" aria-label="Reddit Trending">
      <div class="row">
        <strong style="font-size:16px">Reddit Trending (past 24h)</strong>
        <span class="pill">Most-mentioned tickers on stock subreddits</span>
        <span class="right"></span>
      </div>
      <div class="toolbar">
        <label for="trendFilter">Filter</label>
        <select id="trendFilter" title="Pick scope">
          <option value="all-stocks" selected>Popular subreddits</option>
          <option value="stocks">r/stocks</option>
          <option value="wallstreetbets">r/wallstreetbets</option>
          <option value="investing">r/investing</option>
          <option value="options">r/options</option>
        </select>
        <label for="trendLimit">Show</label>
        <select id="trendLimit">
          <option>10</option>
          <option selected>25</option>
          <option>50</option>
        </select>
        <label for="trendSort">Sort by</label>
        <select id="trendSort">
          <option value="rank" selected>Rank</option>
          <option value="mentions">Mentions â†“</option>
          <option value="upvotes">Upvotes â†“</option>
          <option value="ticker">Ticker A-Z</option>
        </select>
        <button id="btnTrending"><span class="spinner" id="spinTrend" style="display:none"></span> Load Reddit Trending</button>
      </div>
      <div id="trendStatus" class="status sub"></div>
      <div id="trendSource" class="pill" style="margin-top:8px;display:none"></div>
      <div id="trendList" style="display:grid;gap:8px;margin-top:10px"></div>
      <div class="small sub">Source: <span id="trendSourceLabel">Loading...</span></div>
    </section>
  </div>

  <!-- LOGIN OVERLAY -->
  <div class="login-overlay" id="loginOverlay">
    <div class="login-modal">
      <h2 class="login-title">Login Required</h2>
      <p class="login-sub">Please login to access the market news tool</p>
      
      <div class="login-field">
        <label for="loginEmail">Email</label>
        <input id="loginEmail" type="email" placeholder="your@email.com" />
      </div>
      
      <div class="login-field">
        <label for="loginPassword">Password</label>
        <input id="loginPassword" type="password" placeholder="Your password" />
      </div>
      
      <div class="login-actions">
        <button id="btnLogin">Login</button>
        <button id="btnRegister" class="ghost">Register</button>
        <button id="btnTestAccess" class="ghost" style="background: rgba(245,158,11,.12); color: #fbbf24; border-color: #92400e;">Test Access (5 min)</button>
      </div>
      
      <div id="loginStatus" class="status sub" style="margin-top:16px"></div>
    </div>
  </div>

  <script>
    /* ================== CONFIGURE YOUR WORKER ENDPOINTS ================== */
    const SUMMARIZER_URL = 'https://summarizev3.451jscholz.workers.dev/summarize';
    const TRENDING_URL = 'https://summarizev3.451jscholz.workers.dev/reddit-trending';
    const AUTH_URL = 'https://summarizev3.451jscholz.workers.dev/auth';

    /* ================== Banner if opened from file:// ================== */
    (function(){
      if(location.protocol === 'file:'){
        const b = document.getElementById('banner');
        b.style.display='block';
        b.innerHTML = 'Opened locally';
      }
    })();

    /* ================== Authentication System ================== */
    const Auth = {
      get session() { 
        try {
          return JSON.parse(localStorage.getItem('sns_auth_session') || 'null');
        } catch {
          return null;
        }
      },
      set session(data) { 
        localStorage.setItem('sns_auth_session', JSON.stringify(data));
      },
      get usage() {
        try {
          return JSON.parse(localStorage.getItem('sns_usage_tracking') || '{"requests":0,"lastReset":' + Date.now() + '}');
        } catch {
          return {requests:0,lastReset:Date.now()};
        }
      },
      set usage(data) {
        localStorage.setItem('sns_usage_tracking', JSON.stringify(data));
      },
      isLoggedIn() {
        const session = this.session;
        return session && session.email && session.expiresAt && Date.now() < session.expiresAt;
      },
      logout() {
        localStorage.removeItem('sns_auth_session');
        this.hideUserInfo();
        this.showLogin();
      },
      showUserInfo() {
        const session = this.session;
        if (session) {
          $('#userEmail').textContent = session.email;
          $('#userInfo').classList.remove('hidden');
          this.updateUsageDisplay();
        }
      },
      hideUserInfo() {
        $('#userInfo').classList.add('hidden');
      },
      showLogin() {
        $('#loginOverlay').style.display = 'flex';
      },
      hideLogin() {
        $('#loginOverlay').style.display = 'none';
      },
      trackUsage() {
        let usage = this.usage;
        const now = Date.now();
        const dayMs = 24 * 60 * 60 * 1000;
        
        // Reset daily usage if needed
        if (now - usage.lastReset > dayMs) {
          usage = {requests:0,lastReset:now};
        }
        
        usage.requests++;
        this.usage = usage;
        this.updateUsageDisplay();
      },
      updateUsageDisplay() {
        const usage = this.usage;
        const dailyLimit = 100; // Set your daily limit here
        $('#usageInfo').textContent = `${usage.requests}/${dailyLimit} requests today`;
      },
      checkUsageLimit() {
        const usage = this.usage;
        const dailyLimit = 100;
        return usage.requests < dailyLimit;
      }
    };

    /* ================== Local storage for API keys ================== */
    const S = { 
      get finnhubKey(){ return localStorage.getItem('sns_finnhub_key') || '' }, 
      set finnhubKey(v){ localStorage.setItem('sns_finnhub_key', v) },
      get aiKey(){ return localStorage.getItem('sns_ai_key') || '' }, 
      set aiKey(v){ localStorage.setItem('sns_ai_key', v) }
    };

    // AI Configuration
    const getAIKey = () => S.aiKey;
    const AI_BASE_URL = 'https://api.openai.com/v1';
    const AI_MODEL = 'gpt-3.5-turbo';

    /* ================== Helpers ================== */
    const $ = s => document.querySelector(s);
    const el = (t,p={},...c)=>{ const n=Object.assign(document.createElement(t),p); c.filter(x=>x!=null).forEach(x=>n.append(x)); return n; };
    const setStatus = (m)=> $('#status').textContent = m || '';
    const setCount = (n)=> $('#count').textContent = n? `${n} article${n===1?'':'s'}` : '';
    const isTicker = (q)=> /^[A-Z.\-]{1,7}$/.test(String(q||'').trim());
    const niceTime = (s)=>{ const d=new Date(s); return isNaN(d.getTime())? '' : d.toLocaleString(); };
    const log = (msg, cls='')=> $('#log').append(el('div',{className:cls}, msg));
    const clearLog = ()=> $('#log').innerHTML='';
    const setLoginStatus = (m)=> $('#loginStatus').textContent = m || '';

    /* ================== Authentication Functions ================== */
    async function loginUser() {
      const email = $('#loginEmail').value.trim();
      const password = $('#loginPassword').value.trim();
      
      if (!email || !password) {
        setLoginStatus('Please enter email and password');
        return;
      }
      
      setLoginStatus('Logging in...');
      
      try {
        // For demo purposes, accept any email/password
        // In production, replace with actual API call:
        // const r = await fetch(AUTH_URL + '/login', {
        //   method: 'POST',
        //   headers: { 'Content-Type': 'application/json' },
        //   body: JSON.stringify({ email, password })
        // });
        
        // Demo authentication - remove this in production
        if (email && password.length >= 4) {
          const session = {
            email: email,
            token: 'demo-token-' + Date.now(),
            expiresAt: Date.now() + (24 * 60 * 60 * 1000), // 24 hours
            userId: 'demo-user'
          };
          
          Auth.session = session;
          Auth.hideLogin();
          Auth.showUserInfo();
          setLoginStatus('');
          return;
        }
        
        throw new Error('Invalid credentials');
        
      } catch (error) {
        setLoginStatus('Login failed: ' + error.message);
      }
    }
    
    async function registerUser() {
      const email = $('#loginEmail').value.trim();
      const password = $('#loginPassword').value.trim();
      
      if (!email || !password) {
        setLoginStatus('Please enter email and password');
        return;
      }
      
      if (password.length < 4) {
        setLoginStatus('Password must be at least 4 characters');
        return;
      }
      
      setLoginStatus('Creating account...');
      
      try {
        // For demo purposes, auto-register any valid email
        // In production, replace with actual API call:
        // const r = await fetch(AUTH_URL + '/register', {
        //   method: 'POST',
        //   headers: { 'Content-Type': 'application/json' },
        //   body: JSON.stringify({ email, password })
        // });
        
        // Demo registration - remove this in production
        const session = {
          email: email,
          token: 'demo-token-' + Date.now(),
          expiresAt: Date.now() + (24 * 60 * 60 * 1000),
          userId: 'demo-user'
        };
        
        Auth.session = session;
        Auth.hideLogin();
        Auth.showUserInfo();
        setLoginStatus('');
        
      } catch (error) {
        setLoginStatus('Registration failed: ' + error.message);
      }
    }
    
    function grantTestAccess() {
      setLoginStatus('Granting 5-minute test access...');
      
      try {
        // Create temporary test session for 5 minutes
        const session = {
          email: 'test@demo.com',
          token: 'test-token-' + Date.now(),
          expiresAt: Date.now() + (5 * 60 * 1000), // 5 minutes
          userId: 'test-user',
          isTestAccess: true
        };
        
        Auth.session = session;
        Auth.hideLogin();
        Auth.showUserInfo();
        setLoginStatus('');
        
        // Show notification about test access
        const banner = document.getElementById('banner');
        banner.style.display = 'block';
        banner.innerHTML = 'âš ï¸ Test Access Active - Expires in 5 minutes';
        banner.style.background = 'rgba(245,158,11,.12)';
        banner.style.color = '#fbbf24';
        banner.style.borderColor = '#92400e';
        
        // Auto-logout after 5 minutes
        setTimeout(() => {
          if (Auth.session && Auth.session.isTestAccess) {
            Auth.logout();
            alert('Test access has expired. Please login for continued access.');
          }
        }, 5 * 60 * 1000);
        
      } catch (error) {
        setLoginStatus('Test access failed: ' + error.message);
      }
    }
    
    function requireAuth() {
      if (!Auth.isLoggedIn()) {
        Auth.showLogin();
        return false;
      }
      return true;
    }

    function decodeEntities(str) {
      const txt = document.createElement('textarea');
      txt.innerHTML = (str ?? '').toString();
      return txt.value;
    }
    function cleanText(t) {
      if (!t) return '';
      let s = String(t).trim();
      s = s.replace(/^```(?:json)?\s*/i,'').replace(/```$/,'').trim();
      try {
        const maybe = JSON.parse(s);
        if (maybe && typeof maybe === 'object' && (maybe.summary || maybe.Summary)) {
          s = String(maybe.summary || maybe.Summary || '');
        }
      } catch {}
      s = s.replace(/^"(.*)"$/,'$1').replace(/^'(.*)'$/,'$1').trim();
      return decodeEntities(s);
    }
    function cleanBullet(b) { let s = cleanText(b); s = s.replace(/^\s*[-â€¢]\s*/,'').trim(); return s; }
    function coerceBullets(raw) {
      if (!raw) return [];
      if (Array.isArray(raw)) return raw.map(cleanBullet).filter(Boolean);
      if (typeof raw === 'string') return cleanText(raw).split(/\r?\n+/).map(x=>x.replace(/^\s*[-â€¢]\s*/, '').trim()).filter(Boolean);
      if (typeof raw === 'object') {
        if (Array.isArray(raw.bullets)) return raw.bullets.map(cleanBullet).filter(Boolean);
        const vals = Object.values(raw).filter(v => typeof v === 'string');
        if (vals.length) return vals.map(cleanBullet).filter(Boolean);
      }
      return [];
    }

    /* ================== Sentiment scoring + tags ================== */
    const POS = [/\bbeats?\b|surge|raise(s)? guidance|record(\s+\w+){0,3}\s+revenue|upgrade|outperform|accelerat(es|ed|ing)|tops? estimates|strong demand/i];
    const NEG = [/\bmiss(es|ed)?\b|plunge|downgrade|recall|probe|investigation|cuts? guidance|guidance cut|sec\b|ftc\b|antitrust|shortfall|layoffs?/i];
    function scoreHeadline(h){ let s=0; for(const r of POS) if(r.test(h)) s+=1; for(const r of NEG) if(r.test(h)) s-=1; return s; }
    function sentimentFromScore(s){ return s>0? {label:'Bullish', cls:'bull'} : s<0? {label:'Bearish', cls:'bear'} : {label:'Neutral', cls:'neutral'}; }
    function extractTags(h){
      const tags=[];
      if(/\bbeat(s|ing)?\b|tops? estimates|record/i.test(h)) tags.push({t:'Earnings', cls:'tag'});
      if(/raise(s)? guidance|guidance\s+raised|increase\s+outlook/i.test(h)) tags.push({t:'Guidance â†‘', cls:'tag'});
      if(/cuts? guidance|guidance cut|lower(s)? outlook/i.test(h)) tags.push({t:'Guidance â†“', cls:'warn'});
      if(/upgrade|initiates? (buy|outperform|overweight)/i.test(h)) tags.push({t:'Upgrade', cls:'tag'});
      if(/downgrade|initiates? (sell|underperform|underweight)/i.test(h)) tags.push({t:'Downgrade', cls:'warn'});
      if(/recall/i.test(h)) tags.push({t:'Recall', cls:'warn'});
      if(/probe|investigation|sec\b|ftc\b|antitrust/i.test(h)) tags.push({t:'Regulatory', cls:'warn'});
      if(/price target (raised|hiked)/i.test(h)) tags.push({t:'PT â†‘', cls:'tag'});
      if(/price target (cut|slashed)/i.test(h)) tags.push({t:'PT â†“', cls:'warn'});
      return tags;
    }

    /* ================== Enhanced AI Functions ================== */
    
    // AI-powered sentiment analysis using GPT-4
    async function analyzeSentimentWithAI(text) {
      const apiKey = getAIKey();
      if (!apiKey) {
        return { sentiment: 'neutral', confidence: 0.5, reasoning: 'AI API key not configured' };
      }
      
      // Rate limiting check
      const now = Date.now();
      if (now - lastAIRequest < AI_RATE_LIMIT_DELAY) {
        return { sentiment: 'neutral', confidence: 0.3, reasoning: 'Rate limited - please wait' };
      }
      lastAIRequest = now;
      
      try {
        const response = await fetch(`${AI_BASE_URL}/chat/completions`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: AI_MODEL,
            messages: [{
              role: 'user',
              content: `You are a trader analyzing market sentiment. Tell me HOW TO TRADE this news, not what the news says.

FORBIDDEN: Do NOT describe the news. Do NOT summarize the headline. Do NOT restate content.

REQUIRED: Tell me what this means for TRADING and INVESTING.

Return JSON with:
{
  "sentiment": "bullish|bearish|neutral",
  "confidence": 0.0-1.0,
  "reasoning": "why this makes the stock go up/down - focus on money impact",
  "market_impact": "high|medium|low",
  "key_factors": ["money-driving factors", "trading catalysts", "market psychology elements"],
  "investor_implications": "should investors buy/sell/hold and specific timing considerations"
}

Headline: "${text}"

EXAMPLE: If headline says "Company beats earnings", you MUST say "Beat expectations means institutional buying pressure, short squeeze likely, momentum traders will jump in, stock could run 5-10% next week - consider buying now or waiting for dip."

TRADE ANALYSIS, NOT NEWS SUMMARY!`
            }],
            temperature: 0.1
          })
        });
        
        const data = await response.json();
        const analysis = JSON.parse(data.choices[0].message.content);
        return analysis;
      } catch (error) {
        console.error('AI sentiment analysis failed:', error);
        return { sentiment: 'neutral', confidence: 0.3, reasoning: 'AI analysis failed' };
      }
    }
    
    // AI-powered news categorization
    async function categorizeNewsWithAI(title, description) {
      const apiKey = getAIKey();
      if (!apiKey) {
        return { category: 'General', subcategory: 'News', tags: [] };
      }
      
      // Rate limiting check
      const now = Date.now();
      if (now - lastAIRequest < AI_RATE_LIMIT_DELAY) {
        return { category: 'General', subcategory: 'News', tags: [], relevance_score: 0.5, reasoning: 'Rate limited - please wait' };
      }
      lastAIRequest = now;
      
      try {
        const response = await fetch(`${AI_BASE_URL}/chat/completions`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: AI_MODEL,
            messages: [{
              role: 'user',
              content: `You are a market analyst categorizing news for TRADERS. Tell me which MARKET SEGMENT this affects and HOW to trade it.

FORBIDDEN: Do NOT describe the news content. Do NOT summarize what happened.

REQUIRED: Focus on MARKET IMPACT and TRADING OPPORTUNITIES.

Return JSON with:
{
  "category": "Earnings|M&A|Regulatory|Product|Market|Guidance|Analyst|Other",
  "subcategory": "specific trading catalyst type",
  "tags": ["market-moving", "trading", "catalyst", "tags"],
  "relevance_score": 0.0-1.0,
  "market_focus": "which market segment/sector will move and why",
  "key_entities": ["stocks that will react", "affected sectors", "related ETFs"]
}

Title: "${title}"
Description: "${description}"

EXAMPLE: If news says "FDA approves new drug", you MUST say "Biotech sector catalyst, pharma stocks will move, check related biotech ETFs, watch for sector rotation - this affects healthcare trading."

MARKET IMPACT ANALYSIS, NOT NEWS DESCRIPTION!`
            }],
            temperature: 0.2
          })
        });
        
        const data = await response.json();
        const categorization = JSON.parse(data.choices[0].message.content);
        return categorization;
      } catch (error) {
        console.error('AI categorization failed:', error);
        return { category: 'General', subcategory: 'News', tags: [], relevance_score: 0.5 };
      }
    }
    
    // Rule-based market analysis (replaces unreliable AI)
    async function getEnhancedAISummary(title, description, url) {
      // Extract ticker from title/description for price analysis
      const ticker = extractTicker(title, description);
      let priceData = null;
      
      if (ticker) {
        priceData = await getStockPrice(ticker);
      }
      
      // Completely bypass AI - use rule-based analysis that never summarizes
      return analyzeMarketNews(title, description, ticker, priceData);
    }
    
    // Extract stock ticker from news content
    function extractTicker(title, description) {
      const text = (title + ' ' + description).toUpperCase();
      
      // Common stock tickers (prioritized by frequency)
      const commonTickers = ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'TSLA', 'META', 'NVDA', 'JPM', 'JNJ', 'V', 'PG', 'UNH', 'HD', 'MA', 'DIS', 'BAC', 'CSCO', 'XOM', 'VZ', 'CRM', 'NFLX', 'ADBE', 'PYPL', 'INTC', 'CMCSA', 'PEP', 'T', 'COST', 'KO', 'NKE', 'ABT', 'MRK', 'DHR', 'MDT', 'ABBV', 'AVGO', 'TXN', 'HON', 'NEE', 'QCOM', 'UPS', 'LIN', 'LLY', 'LOW', 'AMD', 'TMO', 'SBUX', 'AMGN', 'CAT', 'CVX', 'GE', 'PLD', 'UNP', 'SCHW', 'HCA', 'DE', 'ISRG', 'GILD', 'CB', 'NOW', 'AMAT', 'BA', 'FI', 'DXCM', 'RTX', 'SPGI', 'BKNG', 'EL', 'ICE', 'CL', 'TMUS', 'ADI', 'ZTS', 'CDNS', 'PGR', 'SNPS', 'ORLY', 'REGN', 'MO', 'MDLZ', 'EQIX', 'APH', 'ATVI', 'LMT', 'ADP', 'CSX', 'CTSH', 'MCD', 'CME', 'AON', 'MMC', 'NOC', 'PLTR', 'SO', 'LRCX', 'ROP', 'MCO', 'TFC', 'FDX', 'INTU', 'WM', 'DELL', 'WFC', 'PODD', 'AJG', 'ACN', 'ECL', 'HUM', 'AEP', 'OXY', 'WMT', 'MET', 'USB', 'RSG', 'A', 'MS', 'BLK', 'GS', 'AXP', 'IBM', 'TRV', 'C', 'COF', 'SPG', 'KMI', 'K', 'ALL', 'HAL', 'CVS', 'PFE', 'BMY', 'SYY', 'MRNA', 'TGT', 'AMT', 'DUK', 'BDX', 'EOG', 'MMM', 'PNC', 'SLB', 'ZBH', 'YUM', 'D', 'F', 'GM', 'CI', 'ELV', 'CLX', 'MAA', 'HIG', 'AIG', 'PRU', 'MET', 'TROW', 'VRSK', 'CNI', 'ETN', 'EIX', 'WRK', 'HES', 'AEE', 'WEC', 'O', 'LNT', 'PEG', 'AWK', 'ED', 'DTE', 'XEL', 'WMB', 'ETR', 'FE', 'CNP', 'NRG', 'AES', 'NI'];
      
      // Look for exact ticker matches (prioritize longer tickers first)
      const sortedTickers = [...commonTickers].sort((a, b) => b.length - a.length);
      for (const ticker of sortedTickers) {
        // Use word boundaries to avoid partial matches
        const regex = new RegExp(`\\b${ticker}\\b`, 'i');
        if (regex.test(text)) {
          return ticker;
        }
      }
      
      // Look for $TICKER pattern
      const tickerMatch = text.match(/\$([A-Z]{1,5})\b/);
      if (tickerMatch) {
        return tickerMatch[1];
      }
      
      return null;
    }
    
    // Get current stock price and basic data
    async function getStockPrice(ticker) {
      try {
        // Using a CORS-friendly proxy for Yahoo Finance API
        const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${ticker}`)}`;
        const response = await fetch(proxyUrl);
        
        if (!response.ok) {
          return getFallbackPriceData(ticker);
        }
        
        const data = await response.json();
        const chart = data.chart?.result?.[0];
        if (!chart) {
          return getFallbackPriceData(ticker);
        }
        
        const currentPrice = chart.meta?.regularMarketPrice;
        const previousClose = chart.meta?.previousClose;
        
        if (!currentPrice || !previousClose) {
          return getFallbackPriceData(ticker);
        }
        
        const change = currentPrice - previousClose;
        const changePercent = (change / previousClose) * 100;
        
        return {
          ticker,
          currentPrice,
          previousClose,
          change,
          changePercent,
          volume: chart.meta?.regularMarketVolume,
          avgVolume: chart.meta?.averageDailyVolume3Month
        };
        
      } catch (error) {
        return getFallbackPriceData(ticker);
      }
    }
    
    // Fallback price data for demonstration (mock data)
    function getFallbackPriceData(ticker) {
      // Mock price data for major tickers
      const mockPrices = {
        'AAPL': { price: 178.45, change: 2.34, volume: 52000000 },
        'MSFT': { price: 378.92, change: -1.23, volume: 21000000 },
        'GOOGL': { price: 139.67, change: 0.89, volume: 18000000 },
        'AMZN': { price: 145.32, change: 3.21, volume: 41000000 },
        'TSLA': { price: 242.68, change: -5.43, volume: 98000000 },
        'META': { price: 312.45, change: 1.67, volume: 15000000 },
        'NVDA': { price: 467.89, change: 8.92, volume: 45000000 },
        'JPM': { price: 148.23, change: -0.45, volume: 8000000 },
        'V': { price: 248.76, change: 1.12, volume: 6000000 },
        'JNJ': { price: 156.78, change: 0.34, volume: 7000000 }
      };
      
      const mockData = mockPrices[ticker];
      if (!mockData) {
        return null;
      }
      
      const currentPrice = mockData.price;
      const change = mockData.change;
      const changePercent = (change / (currentPrice - change)) * 100;
      
      return {
        ticker,
        currentPrice,
        previousClose: currentPrice - change,
        change,
        changePercent,
        volume: mockData.volume,
        avgVolume: mockData.volume * 0.8
      };
    }
    
    // Comprehensive rule-based market analysis
    function analyzeMarketNews(title, description, ticker = null, priceData = null) {
      const text = (title + ' ' + description).toLowerCase();
      
      // Add price context if available
      let priceContext = '';
      if (priceData) {
        const { currentPrice, changePercent } = priceData;
        priceContext = `Current price $${currentPrice.toFixed(2)}, ${changePercent.toFixed(2)}% today. `;
      }
      
      // Earnings analysis
      if (text.includes('earnings') || text.includes('eps') || text.includes('quarterly')) {
        if (text.includes('beat') || text.includes('exceed') || text.includes('top') || text.includes('better than')) {
          return {
            summary: `${priceContext}Earnings beat signals strong fundamentals - expect institutional buying and upward price momentum. Consider buying positions with 3-6 month horizon.`,
            key_points: [
              "Institutional accumulation likely over next 2 weeks",
              "Watch for analyst upgrades and price target increases",
              "Volume confirmation needed for breakout",
              "Consider related sector ETFs for diversification"
            ],
            market_implications: [
              "Sector strength will benefit competitors",
              "Growth stocks may see rotation into this sector",
              "Options market will see increased call activity"
            ],
            sentiment: "bullish",
            confidence: 0.85,
            investment_thesis: "Buy gradually over next 5 trading days, target 8-12% upside",
            ripple_effects: [
              "Monitor supply chain partners for secondary moves",
              "Check sector ETFs for momentum plays",
              "Watch for short covering rallies"
            ]
          };
        } else if (text.includes('miss') || text.includes('below') || text.includes('fell short') || text.includes('disappoint')) {
          return {
            summary: "Earnings miss indicates fundamental weakness - expect institutional selling and support level testing. Consider reducing exposure or waiting for better entry.",
            key_points: [
              "Support levels at 50-day moving average critical",
              "Watch for analyst downgrades and price target cuts",
              "Volume spike will confirm distribution",
              "Consider hedging with put options"
            ],
            market_implications: [
              "Sector weakness may spread to competitors",
              "Growth stocks could see rotation out of this sector",
              "Risk-off sentiment may benefit defensive sectors"
            ],
            sentiment: "bearish",
            confidence: 0.8,
            investment_thesis: "Sell or wait for retest of key support before considering entry",
            ripple_effects: [
              "Monitor related stocks for contagion effects",
              "Check sector ETFs for short opportunities",
              "Watch for flight to quality in market"
            ]
          };
        }
      }
      
      // M&A analysis
      if (text.includes('acquisition') || text.includes('merger') || text.includes('buy') || text.includes('takeover')) {
        return {
          summary: "M&A activity creates arbitrage opportunities and sector consolidation plays. Target company premium likely, acquirer may see short-term pressure.",
          key_points: [
            "Target company: 20-30% premium to current price expected",
            "Acquirer: short-term pressure on stock due to dilution concerns",
            "Monitor regulatory approval timeline",
            "Consider competitor stocks as consolidation beneficiaries"
          ],
          market_implications: [
              "Sector consolidation will benefit larger players",
              "Private equity valuations in sector may increase",
              "Related M&A activity likely to accelerate"
            ],
            sentiment: "bullish",
            confidence: 0.75,
            investment_thesis: "Buy target company on any dips, consider acquirer after initial pressure",
            ripple_effects: [
              "Watch for competitor M&A speculation",
              "Check related sector ETFs for rotation",
              "Monitor investment banking stocks for deal flow impact"
            ]
          };
      }
      
      // Guidance/Forecast analysis
      if (text.includes('guidance') || text.includes('forecast') || text.includes('outlook') || text.includes('expectation')) {
        if (text.includes('raise') || text.includes('increase') || text.includes('upward') || text.includes('strong')) {
          return {
            summary: "Raised guidance signals management confidence and improving business conditions. Expect multiple expansion and institutional interest.",
            key_points: [
              "Forward P/E multiple expansion likely",
              "Institutional buying will accelerate over next quarter",
              "Watch for earnings estimate revisions upward",
              "Consider increasing position size on strength"
            ],
            market_implications: [
              "Sector outlook upgrades likely across the board",
              "Supply chain partners may see positive revisions",
              "Competitor guidance may also improve"
            ],
            sentiment: "bullish",
            confidence: 0.8,
            investment_thesis: "Buy on any weakness, target 15-20% upside over 6 months",
            ripple_effects: [
              "Monitor supply chain and customer relationships",
              "Check sector ETFs for relative strength",
              "Watch for options flow indicating institutional positioning"
            ]
          };
        } else if (text.includes('cut') || text.includes('lower') || text.includes('reduce') || text.includes('cautious')) {
          return {
            summary: "Cut guidance indicates deteriorating business conditions - expect multiple compression and institutional selling. Reduce exposure immediately.",
            key_points: [
              "Forward P/E multiple compression expected",
              "Institutional selling likely to accelerate",
              "Watch for earnings estimate cuts across analysts",
              "Consider defensive positioning or cash allocation"
            ],
            market_implications: [
              "Sector-wide guidance cuts may follow",
              "Supply chain partners at risk of demand weakness",
              "Competitive pressures may increase"
            ],
            sentiment: "bearish",
            confidence: 0.85,
            investment_thesis: "Sell immediately or wait for significant price decline before reconsidering",
            ripple_effects: [
              "Monitor customer companies for demand weakness",
              "Check sector ETFs for relative underperformance",
              "Watch for flight to defensive sectors"
            ]
          };
        }
      }
      
      // Product/Innovation analysis
      if (text.includes('launch') || text.includes('product') || text.includes('innovation') || text.includes('technology')) {
        return {
          summary: "Product launch creates revenue growth catalyst and competitive advantage. Consider positioning for multi-quarter growth trajectory.",
          key_points: [
            "Revenue impact expected over 2-3 quarters",
            "Market share gains likely against competitors",
            "Watch for customer adoption metrics",
            "Consider related supply chain beneficiaries"
          ],
          market_implications: [
            "Competitive pressure on industry incumbents",
            "Technology sector may see innovation premium",
            "Related component suppliers could benefit"
          ],
            sentiment: "bullish",
            confidence: 0.7,
            investment_thesis: "Buy for growth, target 25-30% upside over 12 months",
            ripple_effects: [
              "Monitor technology suppliers and partners",
              "Check innovation-focused ETFs",
              "Watch for competitor response strategies"
            ]
          };
      }
      
      // Regulatory/Legal analysis
      if (text.includes('regulatory') || text.includes('legal') || text.includes('lawsuit') || text.includes('fined') || text.includes('investigation')) {
        return {
          summary: "Regulatory issues create uncertainty and potential financial impact - avoid until clarity emerges. Consider defensive positioning.",
          key_points: [
            "Legal overhang could persist 12-24 months",
            "Financial impact uncertainty will pressure valuation",
            "Watch for settlement negotiations or regulatory rulings",
            "Consider competitors as alternative investments"
          ],
          market_implications: [
            "Sector regulatory scrutiny may increase",
            "Compliance costs could affect industry margins",
            "Legal precedent may affect other companies"
          ],
          sentiment: "bearish",
          confidence: 0.75,
          investment_thesis: "Avoid or sell, wait for regulatory clarity before reconsidering",
          ripple_effects: [
            "Monitor sector regulatory environment",
            "Check legal risk exposure of competitors",
            "Watch for compliance cost impacts"
          ]
        };
      }
      
      // Default analysis for general news
      return {
        summary: "Market impact uncertain - monitor trading volume and price action for directional clues. Consider waiting for confirmation before taking positions.",
        key_points: [
          "Volume analysis critical for next direction",
          "Key technical levels: 50-day and 200-day moving averages",
          "Monitor sector relative strength",
          "Wait for institutional flow signals"
        ],
        market_implications: [
          "Could affect sector sentiment depending on market reaction",
          "Watch for related stock correlation patterns",
          "Market volatility may increase around this news"
        ],
        sentiment: "neutral",
        confidence: 0.5,
        investment_thesis: "Hold current positions, wait for clear directional signal",
        ripple_effects: [
          "Monitor market breadth indicators",
          "Check sector rotation patterns",
          "Watch for institutional block trading activity"
        ]
      };
    }
    
    // Check if AI is still summarizing instead of analyzing
    function isSummarizing(summary, title, description) {
      const summaryLower = summary.toLowerCase();
      const titleLower = title.toLowerCase();
      const descLower = description.toLowerCase();
      
      // Check if summary contains too many words from original content
      const titleWords = titleLower.split(' ');
      const descWords = descLower.split(' ');
      const summaryWords = summaryLower.split(' ');
      
      let overlapCount = 0;
      summaryWords.forEach(word => {
        if (titleWords.includes(word) || descWords.includes(word)) {
          overlapCount++;
        }
      });
      
      const overlapRatio = overlapCount / summaryWords.length;
      return overlapRatio > 0.3; // If more than 30% overlap, it's probably summarizing
    }
    
    // Force analysis if AI fails to provide it
    function forceAnalysis(title, description) {
      const text = (title + ' ' + description).toLowerCase();
      
      // Simple keyword-based analysis
      let sentiment = 'neutral';
      let investment_thesis = 'Hold pending more information';
      let summary = 'Market reaction uncertain - monitor trading volume and price action';
      let key_points = ['Watch key support/resistance levels', 'Monitor sector performance'];
      let market_implications = ['Could affect related stocks', 'Watch for sector rotation'];
      let ripple_effects = ['Monitor market sentiment', 'Check related ETFs'];
      
      if (text.includes('beat') || text.includes('exceed') || text.includes('raise') || text.includes('upgrade')) {
        sentiment = 'bullish';
        investment_thesis = 'Consider buying on strength';
        summary = 'Positive catalyst suggests upward momentum - watch for institutional buying';
        key_points = ['Breakout potential', 'Volume confirmation needed', 'Support levels holding'];
        market_implications = ['Sector strength likely', 'Related stocks may follow'];
        ripple_effects = ['Check sector ETFs', 'Monitor competitor reactions'];
      } else if (text.includes('miss') || text.includes('cut') || text.includes('downgrade') || text.includes('delay')) {
        sentiment = 'bearish';
        investment_thesis = 'Sell or wait for better entry';
        summary = 'Negative catalyst expected - watch for support level testing';
        key_points = ['Support levels at risk', 'Volume spike likely', 'Consider short positions'];
        market_implications = ['Sector weakness possible', 'Risk-off sentiment'];
        ripple_effects = ['Check put options', 'Monitor related stock declines'];
      }
      
      return {
        summary,
        key_points,
        market_implications,
        sentiment,
        confidence: 0.7,
        investment_thesis,
        ripple_effects
      };
    }
    
    // Rate limiting tracker
    let lastAIRequest = 0;
    const AI_RATE_LIMIT_DELAY = 1000; // 1 second between requests

    // AI key testing function
    async function testAIKey(){
      const key = $('#keyAI').value.trim();
      try {
        if(!key) throw new Error('No key provided');
        
        // Rate limiting check
        const now = Date.now();
        if (now - lastAIRequest < AI_RATE_LIMIT_DELAY) {
          const waitTime = Math.ceil((AI_RATE_LIMIT_DELAY - (now - lastAIRequest)) / 1000);
          throw new Error(`Rate limited. Please wait ${waitTime} seconds.`);
        }
        lastAIRequest = now;
        
        // Test with a simple request using gpt-3.5-turbo (more reliable for testing)
        const response = await fetch(`${AI_BASE_URL}/chat/completions`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${key}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: 'gpt-3.5-turbo',
            messages: [{ role: 'user', content: 'Say "test" if you can read this' }],
            max_tokens: 10,
            temperature: 0
          })
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('OpenAI API Error:', response.status, errorText);
          
          // Handle specific rate limit error
          if (response.status === 429) {
            const resetTime = response.headers.get('retry-after') || '60';
            throw new Error(`Rate limit exceeded. Wait ${resetTime}s then try again.`);
          }
          
          throw new Error(`HTTP ${response.status}: ${errorText.slice(0, 100)}`);
        }
        
        const data = await response.json();
        console.log('OpenAI API Response:', data);
        
        if (data.choices && data.choices[0] && data.choices[0].message) {
          setAIKeyPill('OK', true);
          log('OpenAI: API key working perfectly', 'oktxt');
        } else {
          throw new Error('Invalid response format');
        }
      } catch(e) {
        console.error('OpenAI Test Error:', e);
        if(e.name==='AbortError'){ setAIKeyPill('Timeout', false); log('OpenAI: Request timed out','warntxt'); }
        else if(e instanceof TypeError){ setAIKeyPill('Network Error', false); log('OpenAI: Network/CORS issue','errtxt'); }
        else if(e.message.includes('Rate limit')){ 
          setAIKeyPill('Rate Limited', false); 
          log(`OpenAI: ${e.message}`,'warntxt'); 
        }
        else { 
          setAIKeyPill((e.message||'Error').slice(0,60), false); 
          log(`OpenAI: ${e.message||e}`,'errtxt'); 
        }
      }
    }
    
    // AI key pill status function
    function setAIKeyPill(text, ok){
      const pill = $('#pillAIKey');
      pill.textContent = text;
      pill.style.background = ok ? 'rgba(34,197,94,.12)' : 'rgba(239,68,68,.12)';
      pill.style.color = ok ? '#22c55e' : '#ef4444';
    }

    /* ================== Normalize + de-dupe ================== */
    const norm = (items)=> (items||[]).map(a=>({
      title: a.title||a.headline||'(no title)', url: a.url||a.link||'#', source: a.source||'News',
      description: a.description||a.summary||'', publishedAt: a.publishedAt||a.pubDate||a.date||new Date().toISOString(), provider: 'finnhub'
    }));

    function dedupe(items, mode='url'){
      if(mode==='off') return items; const out=[], seen=new Set();
      for(const it of items){
        let key='';
        if(mode==='url' && it.url){ try{ const u=new URL(it.url); key=u.origin+u.pathname; }catch{ key=it.url; } }
        else { key=(it.title||'')+'|'+(it.source||''); }
        if(!seen.has(key)){ seen.add(key); out.push(it); }
      } return out;
    }

    /* ================== Enhanced AI Summarize & Analysis ================== */
    async function summarizeItem(it, box, btn) {
      if (!requireAuth()) return;
      if (!Auth.checkUsageLimit()) {
        box.className = 'summary-box';
        box.textContent = 'Daily usage limit reached. Please upgrade your plan.';
        return;
      }
      
      try {
        btn.disabled = true; btn.textContent = 'AI Analyzingâ€¦';
        box.innerHTML = '';

        // Get basic summary from existing service
        const payload = { url: it.url, title: it.title, source: it.source || 'News', publishedAt: it.publishedAt || '', max_words: 120, mode: 'auto' };
        console.log('Getting basic summary:', { url: SUMMARIZER_URL, payload });
        
        const r = await fetch(SUMMARIZER_URL, { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          mode: 'cors'
        });
        
        if (!r.ok) throw new Error(`Summarizer HTTP ${r.status}`);
        const j = await r.json();
        if (j.error) throw new Error(j.error);

        // Get AI-enhanced analysis
        const aiAnalysis = await getEnhancedAISummary(it.title, it.description, it.url);
        
        // Add price data to analysis if available
        const ticker = extractTicker(it.title, it.description);
        if (ticker) {
          const priceData = await getStockPrice(ticker);
          if (priceData) {
            aiAnalysis.priceData = priceData;
          }
        }
        
        const aiSentiment = await analyzeSentimentWithAI(it.title);
        const aiCategory = await categorizeNewsWithAI(it.title, it.description);

        Auth.trackUsage(); // Track this request

        box.className = 'summary-box';
        
        // Create enhanced summary display
        const aiBadge = el('span', { className:'pill', style:'background: rgba(34,211,238,.12); color: #22d3ee;' }, 'ðŸ¤– AI Enhanced');
        const sumTitle = el('div', { className:'summary-title' }, 'AI-Powered Analysis');
        
        // Real-time Price Display (if available)
        let priceDisplay = null;
        if (aiAnalysis.priceData) {
          const { currentPrice, change, changePercent, volume, avgVolume } = aiAnalysis.priceData;
          const changeColor = change >= 0 ? '#22c55e' : '#ef4444';
          const changeSymbol = change >= 0 ? '+' : '';
          
          priceDisplay = el('div', { 
            style:'background: linear-gradient(135deg, rgba(34,211,238,.08), rgba(168,85,247,.08)); padding:12px; border-radius:8px; margin:8px 0; border:1px solid rgba(34,211,238,.2);'
          });
          
          priceDisplay.append(
            el('div', { style:'display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;' }, 
              el('span', { style:'font-size:18px; font-weight:bold; color: #22d3ee;' }, `$${currentPrice.toFixed(2)}`),
              el('span', { style:'font-size:14px; color: changeColor; font-weight:bold;' }, `${changeSymbol}${change.toFixed(2)} (${changeSymbol}${changePercent.toFixed(2)}%)`)
            ),
            el('div', { style:'font-size:12px; color: #94a3b8;' }, 
              `Volume: ${volume?.toLocaleString() || 'N/A'} | Avg: ${avgVolume?.toLocaleString() || 'N/A'}`
            )
          );
        }
        
        // AI Summary
        const aiSummary = el('div', { className:'summary-text' }, aiAnalysis.summary || cleanText(j.summary ?? j.Summary ?? ''));
        
        // AI Key Points (Actionable Insights)
        const keyPointsTitle = aiAnalysis.key_points?.length ? el('div', { className:'summary-title' }, 'ðŸ’¡ Actionable Insights') : null;
        const keyPoints = el('ul', { className:'summary-list' });
        if (aiAnalysis.key_points?.length) {
          aiAnalysis.key_points.forEach(point => keyPoints.append(el('li', { style:'color: #fbbf24;' }, point)));
        }

        // Market Implications
        const implicationsTitle = aiAnalysis.market_implications?.length ? el('div', { className:'summary-title' }, 'ðŸ“ˆ Market Impact') : null;
        const implications = el('ul', { className:'summary-list' });
        if (aiAnalysis.market_implications?.length) {
          aiAnalysis.market_implications.forEach(imp => implications.append(el('li', { style:'color: #22d3ee;' }, imp)));
        }

        // Investment Thesis
        const investmentTitle = aiAnalysis.investment_thesis ? el('div', { className:'summary-title' }, 'ðŸŽ¯ Investment Thesis') : null;
        const investmentText = aiAnalysis.investment_thesis ? el('div', { style:'background: rgba(34,197,94,.08); padding:8px; border-left:3px solid #22c55e; margin:8px 0; font-size:13px;' }, aiAnalysis.investment_thesis) : null;

        // Ripple Effects
        const rippleTitle = aiAnalysis.ripple_effects?.length ? el('div', { className:'summary-title' }, 'ðŸŒŠ Ripple Effects') : null;
        const rippleEffects = el('ul', { className:'summary-list' });
        if (aiAnalysis.ripple_effects?.length) {
          aiAnalysis.ripple_effects.forEach(effect => rippleEffects.append(el('li', { style:'color: #a78bfa;' }, effect)));
        }

        // Enhanced AI Sentiment Display
        const sentimentSection = el('div', { style:'background: rgba(34,211,238,.08); padding:8px; border-radius:6px; margin:8px 0;' });
        sentimentSection.append(el('div', { style:'font-weight:bold; margin-bottom:4px;' }, 'ðŸ§  Market Sentiment Analysis'));
        const sentimentBadge = el('span', { 
          className: `chip ${aiSentiment.sentiment === 'bullish' ? 'bull' : aiSentiment.sentiment === 'bearish' ? 'bear' : 'neutral'}` 
        }, `${aiSentiment.sentiment.toUpperCase()} (${Math.round(aiSentiment.confidence * 100)}%)`);
        sentimentSection.append(sentimentBadge);
        
        if (aiSentiment.reasoning) {
          sentimentSection.append(el('div', { style:'margin-top:6px; font-size:12px; color: var(--muted);' }, aiSentiment.reasoning));
        }

        // Key Factors
        const factorsTitle = aiSentiment.key_factors?.length ? el('div', { className:'summary-title' }, 'ðŸ” Key Factors') : null;
        const factors = el('ul', { className:'summary-list' });
        if (aiSentiment.key_factors?.length) {
          aiSentiment.key_factors.forEach(factor => factors.append(el('li', { style:'color: #94a3b8;' }, factor)));
        }

        // Category Display with Market Focus
        const categorySection = el('div', { style:'margin:8px 0;' });
        categorySection.append(el('div', { style:'font-weight:bold; margin-bottom:4px;' }, 'ðŸ“‚ Market Category'));
        const categoryBadge = el('span', { className:'chip tag' }, `${aiCategory.category} - ${aiCategory.subcategory}`);
        categorySection.append(categoryBadge);
        
        if (aiCategory.market_focus) {
          categorySection.append(el('div', { style:'margin-top:4px; font-size:12px; color: var(--muted);' }, `Market Focus: ${aiCategory.market_focus}`));
        }

        // Assemble the enhanced summary
        box.append(aiBadge, sumTitle);
        if (priceDisplay) box.append(priceDisplay);
        box.append(aiSummary);
        if (keyPointsTitle) box.append(keyPointsTitle, keyPoints);
        if (implicationsTitle) box.append(implicationsTitle, implications);
        if (investmentTitle && investmentText) box.append(investmentTitle, investmentText);
        if (rippleTitle) box.append(rippleTitle, rippleEffects);
        
        box.append(sentimentSection);
        if (factorsTitle) box.append(factorsTitle, factors);
        box.append(categorySection);

      } catch (e) {
        console.error('AI Analysis error:', e);
        box.className = 'summary-box';
        box.textContent = `AI Analysis failed: ${e.message || e}`;
      } finally {
        btn.disabled = false; btn.textContent = 'AI Analyze';
      }
    }

    /* ================== Render Finnhub items ================== */
    function render(items){
      const list = $('#results'); list.innerHTML='';
      if(!items.length){ list.append(el('div',{className:'item'},'No articles found.')); setCount(0); return; }
      const sort = $('#sort').value; const sorted=[...items];
      if(sort==='time') sorted.sort((a,b)=>new Date(b.publishedAt)-new Date(a.publishedAt));
      if(sort==='impact') sorted.sort((a,b)=>scoreHeadline(b.title)-scoreHeadline(a.title));

      for(const it of sorted){
        const s = scoreHeadline(it.title||''); const sent = sentimentFromScore(s);
        const chips = extractTags(it.title||'');
        const scoreTxt = s>0? `â–² +${s}` : s<0? `â–¼ ${s}` : 'â€¢ 0'; const scoreCls = s>0? 'score-pos' : s<0? 'score-neg' : '';

        const summaryBox = el('div', { className: 'summary-box' });
        const sumBtn = el('button', { className: 'ghost', style:'margin-top:8px' }, 'ðŸ¤– AI Analyze');
        sumBtn.addEventListener('click', () => summarizeItem(it, summaryBox, sumBtn));

        list.append(
          el('div',{className:'item',role:'listitem'},
            el('div',{}, el('span',{className:'pill'}, niceTime(it.publishedAt)), el('span',{className:'pill'}, it.source||'News'), el('span',{className:'pill'}, 'Finnhub')),
            el('div',{}, el('a',{href:it.url,target:'_blank',rel:'noopener noreferrer'}, it.title)),
            it.description? el('div',{style:'color:#94a3b8;margin-top:6px'}, it.description) : null,
            el('div',{className:'chips'},
              el('span',{className:`chip ${sent.cls}`}, sent.label),
              ...chips.map(c=> el('span',{className:`chip ${c.cls}`}, c.t))
            ),
            el('div',{}, sumBtn),
            summaryBox,
            el('div',{style:'margin-top:6px'}, el('strong',{className:scoreCls}, `Impact score: ${scoreTxt}`))
          )
        );
      }
      setCount(items.length);
    }

    /* ================== Networking (Finnhub) ================== */
    let inflight = [];
    function makeTimedFetch(ms){
      return (url, options={})=>{
        const ctrl = new AbortController(); const id = setTimeout(()=>ctrl.abort(), ms); inflight.push(ctrl);
        return fetch(url, {...options, signal: ctrl.signal}).finally(()=>{ clearTimeout(id); inflight = inflight.filter(c=>c!==ctrl); });
      };
    }
    const tfetch10 = makeTimedFetch(10000);

    function isoFromDaysBack(days){ const to=new Date(); const from=new Date(Date.now()-days*24*60*60*1000); return {from,to}; }
    async function fetchFinnhub(symbol, key, daysBack, max){
      if(!isTicker(symbol)) throw new Error('Ticker required, e.g., NVDA');
      const {from,to} = isoFromDaysBack(daysBack);
      const url = new URL('https://finnhub.io/api/v1/company-news');
      url.searchParams.set('symbol', symbol.trim().toUpperCase());
      url.searchParams.set('from', from.toISOString().slice(0,10));
      url.searchParams.set('to', to.toISOString().slice(0,10));
      url.searchParams.set('token', key);
      const r = await tfetch10(url);
      if(!r.ok) throw new Error(`Finnhub HTTP ${r.status}`);
      const j = await r.json();
      const items = (Array.isArray(j)? j: []).map(a=>({ title: a.headline, url: a.url, source: a.source, description: a.summary, publishedAt: a.datetime? new Date(a.datetime*1000).toISOString(): undefined }));
      return norm(items).slice(0, max);
    }

    /* ================== Reddit Trending (with fallback to mock data) ================== */
    let currentTrendingData = [];

    async function loadTrending(){
      if (!requireAuth()) return;
      if (!Auth.checkUsageLimit()) {
        $('#trendStatus').textContent = 'Daily usage limit reached. Please upgrade your plan.';
        return;
      }
      
      const filter = $('#trendFilter').value;
      const limit  = parseInt($('#trendLimit').value,10) || 25;
      const spin = $('#spinTrend'); spin.style.display='inline-block';
      $('#trendStatus').textContent = 'Loading Reddit trendingâ€¦';
      $('#trendList').innerHTML = '';
      let source = 'Unknown';
      try{
        Auth.trackUsage(); // Track this request
        // Try Worker first
        try {
          const qs = new URLSearchParams({ filter, limit: String(limit) });
          const url = `${TRENDING_URL}?${qs.toString()}`;
          const r = await fetch(url, { method: 'GET', mode: 'cors' });
          if(r.ok) {
            const data = await r.json();
            source = data.note ? 'ðŸ“Š Demo Data (Worker API failed)' : 'âœ… Reddit';
            $('#trendStatus').textContent = `${data.count} trending tickers â€¢ ${new Date(data.asOf).toLocaleString()}`;
            $('#trendSourceLabel').textContent = source;
            currentTrendingData = data.results || [];
            renderTrending(currentTrendingData);
            return;
          }
        } catch (workerError) {
          console.log('Worker failed:', workerError.message);
        }

        // Try Finnhub trending (more reliable)
        const finnhubKey = $('#keyFinnhub').value.trim();
        if (finnhubKey) {
          try {
            const r = await fetch(`https://finnhub.io/api/v1/news?category=general&limit=${limit}&token=${finnhubKey}`);
            if(r.ok) {
              const data = await r.json();
              const tickers = {};
              (data || []).forEach(article => {
                const matches = article.headline.match(/\b[A-Z]{1,5}\b/g) || [];
                matches.forEach(ticker => {
                  if (!tickers[ticker]) tickers[ticker] = { ticker, mentions: 0, name: ticker, upvotes: 0 };
                  tickers[ticker].mentions++;
                });
              });
              const results = Object.values(tickers)
                .sort((a,b) => b.mentions - a.mentions)
                .slice(0, limit)
                .map((item, idx) => ({...item, rank: idx + 1}));
              if (results.length > 0) {
                source = 'âœ… Real Data (Finnhub API)';
                $('#trendStatus').textContent = `${results.length} trending tickers â€¢ ${new Date().toLocaleString()}`;
                $('#trendSourceLabel').textContent = source;
                currentTrendingData = results;
                renderTrending(currentTrendingData);
                return;
              }
            }
          } catch (e) {
            console.log('Finnhub trending failed:', e.message);
          }
        }

        // Fallback: Mock trending data (demo)
        const mockTrending = [
          { rank: 1, ticker: 'NVDA', name: 'NVIDIA Corp', mentions: 1247, upvotes: 3421 },
          { rank: 2, ticker: 'TSLA', name: 'Tesla Inc', mentions: 1089, upvotes: 2983 },
          { rank: 3, ticker: 'MSFT', name: 'Microsoft Corp', mentions: 956, upvotes: 2654 },
          { rank: 4, ticker: 'AAPL', name: 'Apple Inc', mentions: 847, upvotes: 2341 },
          { rank: 5, ticker: 'AMZN', name: 'Amazon.com Inc', mentions: 743, upvotes: 2015 },
          { rank: 6, ticker: 'GOOGL', name: 'Alphabet Inc', mentions: 698, upvotes: 1876 },
          { rank: 7, ticker: 'META', name: 'Meta Platforms', mentions: 612, upvotes: 1654 },
          { rank: 8, ticker: 'NFLX', name: 'Netflix Inc', mentions: 534, upvotes: 1423 },
          { rank: 9, ticker: 'COIN', name: 'Coinbase Global', mentions: 478, upvotes: 1287 },
          { rank: 10, ticker: 'AI', name: 'C3 Metrics Inc', mentions: 412, upvotes: 1098 },
        ].slice(0, limit);
        
        source = 'ðŸ“Š Demo Data (No API available)';
        $('#trendStatus').textContent = `${mockTrending.length} trending tickers â€¢ ${new Date().toLocaleString()}`;
        $('#trendSourceLabel').textContent = source;
        currentTrendingData = mockTrending;
        renderTrending(currentTrendingData);
      }catch(e){
        source = 'ðŸ“Š Demo Data (Error occurred)';
        $('#trendStatus').textContent = `Trending failed: ${e.message||e}.`;
        $('#trendSourceLabel').textContent = source;
        // Show demo data on any error
        const demoData = [
          { rank: 1, ticker: 'NVDA', name: 'NVIDIA Corp', mentions: 1247, upvotes: 3421 },
          { rank: 2, ticker: 'TSLA', name: 'Tesla Inc', mentions: 1089, upvotes: 2983 },
          { rank: 3, ticker: 'MSFT', name: 'Microsoft Corp', mentions: 956, upvotes: 2654 },
        ];
        currentTrendingData = demoData;
        renderTrending(currentTrendingData.slice(0, limit));
      }finally{
        spin.style.display='none';
      }
    }

    function renderTrending(rows){
      const host = $('#trendList'); host.innerHTML = '';
      if(!rows.length){ host.textContent = 'No trending tickers found.'; return; }

      // Apply sorting
      const sortBy = $('#trendSort').value;
      let sortedRows = [...rows];
      
      switch(sortBy) {
        case 'mentions':
          sortedRows.sort((a, b) => (b.mentions || 0) - (a.mentions || 0));
          break;
        case 'upvotes':
          sortedRows.sort((a, b) => (b.upvotes || 0) - (a.upvotes || 0));
          break;
        case 'ticker':
          sortedRows.sort((a, b) => (a.ticker || '').localeCompare(b.ticker || ''));
          break;
        case 'rank':
        default:
          sortedRows.sort((a, b) => (a.rank || 999) - (b.rank || 999));
          break;
      }

      host.append(el('div',{className:'trend-grid trend-header'},
        el('div',{},'#'),
        el('div',{},'Ticker'),
        el('div',{},'Name'),
        el('div',{},'Mentions'),
        el('div',{},'Upvotes'),
        el('div',{},'Action')
      ));

      sortedRows.forEach(r=>{
        const row = el('div',{className:'trend-row'},
          el('div',{}, String(r.rank ?? '')),
          el('div',{}, String(r.ticker ?? '')),
          el('div',{}, String(r.name ?? '')),
          el('div',{}, String(r.mentions ?? '')),
          el('div',{}, String(r.upvotes ?? '')),
          el('div',{className:'trend-actions'},
            el('button',{className:'ghost',onclick:()=>{ $('#ticker').value = (r.ticker||'').toUpperCase(); startSearch(); }},'Open News')
          )
        );
        host.append(row);
      });
    }

    function sortTrendingData() {
      if (currentTrendingData.length > 0) {
        renderTrending(currentTrendingData);
      }
    }

    /* ================== Key test / UI wiring ================== */
    async function testKey(){
      const key = $('#keyFinnhub').value.trim();
      try {
        if(!key) throw new Error('No key');
        await fetchFinnhub('MSFT', key, 7, 1);
        setKeyPill('OK', true); log('Finnhub: OK','oktxt');
      } catch(e) {
        if(e.name==='AbortError'){ setKeyPill('Timeout', false); log('Finnhub: timed out (10s)','warntxt'); return; }
        if(e instanceof TypeError){ setKeyPill('Network/CORS', false); log('Finnhub: network/CORS issue','errtxt'); return; }
        setKeyPill((e.message||'Error').slice(0,60), false); log(`Finnhub: ${e.message||e}`,'errtxt');
      }
    }
    function setKeyPill(text, ok){ const p = $('#pillKey'); p.textContent = text; p.classList.remove('ok','err'); p.classList.add(ok? 'ok':'err'); }

    async function startSearch(){
      if (!requireAuth()) return;
      if (!Auth.checkUsageLimit()) {
        setStatus('Daily usage limit reached. Please upgrade your plan.');
        return;
      }
      
      clearLog();
      const key=$('#keyFinnhub').value.trim(); const symbol=$('#ticker').value.trim();
      const daysBack=parseInt($('#daysBack').value,10); const max=parseInt($('#maxResults').value,10);
      if(!key){ setStatus('Paste your Finnhub key and click Save.'); return; }
      if(!symbol){ setStatus('Type a ticker, e.g., NVDA.'); return; }
      setStatus('Fetching company newsâ€¦'); $('#btnStart').disabled=true; $('#btnCancel').disabled=true; $('#spin').style.display='inline-block';
      try{
        Auth.trackUsage(); // Track this request
        const items = await fetchFinnhub(symbol, key, daysBack, max);
        const deduped = dedupe(items, $('#dedupe').value);
        render(deduped);
        setStatus(deduped.length? '' : 'No results.');
      } catch(e){
        if(e.name==='AbortError'){ setStatus('Timed out (10s). Try again.'); log('Finnhub: timed out (10s)','warntxt'); }
        else if(e instanceof TypeError){ setStatus('Network/CORS error. If opened as file://, host over HTTPS.'); log('Finnhub: network/CORS issue','errtxt'); }
        else { setStatus(e.message||String(e)); log(`Finnhub: ${e.message||e}`,'errtxt'); }
      } finally {
        $('#btnStart').disabled=false; $('#btnCancel').disabled=true; $('#spin').style.display='none';
      }
    }
    function cancelSearch(){ inflight.forEach(c=>c.abort()); inflight=[]; setStatus('Canceled.'); $('#btnStart').disabled=false; $('#btnCancel').disabled=true; $('#spin').style.display='none'; log('Canceled current requests.','warntxt'); }

    (function init(){
      // Initialize authentication
      if (Auth.isLoggedIn()) {
        Auth.hideLogin();
        Auth.showUserInfo();
      } else {
        Auth.showLogin();
      }
      
      $('#keyFinnhub').value = S.finnhubKey || ''; setKeyPill(S.finnhubKey? 'Saved' : 'Not saved', !!S.finnhubKey);
      $('#btnSave').addEventListener('click', ()=>{ S.finnhubKey = $('#keyFinnhub').value.trim(); setKeyPill(S.finnhubKey? 'Saved':'Not saved', !!S.finnhubKey); });
      $('#btnTest').addEventListener('click', testKey);
      
      // AI API key setup
      $('#keyAI').value = S.aiKey || ''; setAIKeyPill(S.aiKey? 'Saved' : 'Not saved', !!S.aiKey);
      $('#btnSaveAI').addEventListener('click', ()=>{ S.aiKey = $('#keyAI').value.trim(); setAIKeyPill(S.aiKey? 'Saved':'Not saved', !!S.aiKey); });
      $('#btnTestAI').addEventListener('click', testAIKey);
      $('#btnStart').addEventListener('click', startSearch);
      $('#btnCancel').addEventListener('click', cancelSearch);
      $('#ticker').addEventListener('keydown',(e)=>{ if(e.key==='Enter') startSearch(); });

      $('#btnTrending').addEventListener('click', loadTrending);
      $('#trendSort').addEventListener('change', sortTrendingData);
      
      // Authentication event listeners
      $('#btnLogin').addEventListener('click', loginUser);
      $('#btnRegister').addEventListener('click', registerUser);
      $('#btnTestAccess').addEventListener('click', grantTestAccess);
      $('#btnLogout').addEventListener('click', Auth.logout.bind(Auth));
      
      // Handle Enter key in login fields
      $('#loginPassword').addEventListener('keydown',(e)=>{ if(e.key==='Enter') loginUser(); });
      $('#loginEmail').addEventListener('keydown',(e)=>{ if(e.key==='Enter') loginUser(); });

      ['sort','dedupe','maxResults','daysBack'].forEach(id=>{
        document.getElementById(id).addEventListener('change',()=>{
          const cards = Array.from($('#results').children).map(card=>({
            title: card.querySelector('a')?.textContent||'',
            url: card.querySelector('a')?.href||'#',
            source: card.querySelectorAll('.pill')[1]?.textContent||'News',
            description: card.querySelector("div[style^='color']")?.textContent||'',
            publishedAt: card.querySelectorAll('.pill')[0]?.textContent||new Date().toISOString()
          }));
          const max = parseInt($('#maxResults').value,10);
          render(cards.slice(0,max));
        });
      });
    })();
  </script>
</body>
</html>